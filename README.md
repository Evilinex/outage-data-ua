# outage-data-ua

Публічне сховище та інструменти для автоматичного збирання, парсингу і публікації даних про планові відключення електроенергії в Україні.

Проєкт отримує дані з відкритих вебсторінок постачальників, парсить об’єкти `DisconSchedule.fact` і `DisconSchedule.preset` та зберігає їх у JSON «як є» (машиночитно) у директорії `data/`.

---

## Що всередині
- Скрипти Bash/Node.js для:
    - отримання HTML сторінок:
      - через Playwright (headless Chromium) — `scripts/fetch_regions_playwright.mjs` (основний спосіб у CI)
      - через `curl` з «браузероподібними» заголовками — `scripts/fetch_regions.sh` (швидкий локальний варіант)
    - парсингу об’єктів `DisconSchedule.fact` і `DisconSchedule.preset` зі сторінки та запису їх «як є» у JSON (`scripts/parse_regions.sh`, `scripts/parse_fact.js`)
- Конвеєр GitHub Actions, що кожні 15 хвилин:
    1) за допомогою Playwright завантажує сторінки для кожного регіону
    2) парсить дані та оновлює `data/<region>.json`
    3) комітить і пушить зміни у `main` (якщо файли змінилися)

> Примітка: якщо сторінка захищена антибот‑механізмом і замість контенту віддається сторінка WAF (напр., Incapsula), парсер фіксує помилку, зберігаючи попередні коректні дані у JSON.

---

## Формат даних
Кожен регіон зберігається у файлі `data/<region>.json`. Базова структура (скорочено):

```json
{
  "regionId": "kyiv",
  "lastUpdated": "2025-11-06T11:41:56.430Z",
  "fact": { "updateFact": "06.11.2025 09:09" },
  "preset": { "updateFact": "04.11.2025 18:00" },
  "lastUpdateStatus": { "status": "parsed", "ok": true, "code": 200, "message": null, "at": "2025-11-06T11:41:56.430Z", "attempt": 5 },
  "meta": { "schemaVersion": "1.0.0", "contentHash": "..." }
}
```

- `preset` — планові відключення на тиждень для кожної групи (тижневий шаблон), як у вихідному HTML. Зберігається «як є», без нормалізації структури.
- `fact` — фактичні/аварійні відключення на сьогодні та завтра для кожної групи, як у вихідному HTML. Також зберігається «як є».
- `preset` може бути `null`, якщо в HTML його немає або він не парситься (це очікувана ситуація, дані `fact` при цьому зберігаються).
- Кожен із об’єктів (`fact` і `preset`) містить поле `updateFact` — дата й час, на які інформація актуальна (значення з джерела; парсер не змінює формат, зазвичай `dd.MM.yyyy HH:mm` у часовій зоні Europe/Kyiv).
- Видалені попередні поля: `regionName`, `regionType`, а також контейнер `data` — замість нього тепер є сирі об’єкти `fact` і `preset`.
- Блок `meta` мінімальний: тільки `schemaVersion` та `contentHash` (хеш вмісту `fact` + `preset`).
- У разі помилки парсингу парсер оновлює лише `lastUpdateStatus` (наприклад, `status = "error"`, код 422), не стираючи попередні `fact`/`preset`.
- Актуальний шаблон структури — у файлі `data/_template.json`.

### Об’єкт `preset` (тижневий план)
Згідно з реальними файлами, містить щонайменше такі поля (наводимо збережені «як є» ключі):

- `days`: словник номерів днів тижня як рядків `"1".."7"` → назва дня українською.
- `days_mini`: скорочені назви днів тижня, ключі `"1".."7"`.
- `sch_names`: відповідність ідентифікаторів груп (наприклад, `"GPV1.1"`) до людських назв (наприклад, "Черга 1.1").
- `time_zone`: словник годинних слотів `"1".."24"` → масив з трьох елементів `[label, from, to]`, де `from`/`to` у форматі `HH:mm` локального часу.
- `time_type`: перелік кодів стану й їхні текстові пояснення:
  - `yes` — світло є
  - `maybe` — можливе відключення
  - `no` — світла немає (повна година)
  - `first` — не буде перші 30 хв
  - `second` — не буде другі 30 хв
  - `mfirst` — можливо не буде перші 30 хв
  - `msecond` — можливо не буде другі 30 хв
- `data`: вкладений словник із планом на 7 днів:
  - рівень 1: ключ — ідентифікатор групи (наприклад, `"GPV4.1"`).
  - рівень 2: ключ — день тижня `"1".."7"` (1=Пн, 7=Нд).
  - рівень 3: ключ — годинний слот `"1".."24"` (див. `time_zone`).
  - значення — один з кодів із `time_type`.
- `updateFact`: дата/час актуальності довідника/плану (рядок з джерела).

Приклад (урізаний):

```json
{
  "preset": {
    "days": { "1": "Понеділок", "2": "Вівторок" },
    "sch_names": { "GPV4.1": "Черга 4.1" },
    "time_zone": { "1": ["00-01", "00:00", "01:00"], "2": ["01-02", "01:00", "02:00"] },
    "time_type": { "yes": "Світло є", "maybe": "Можливо відключення" },
    "data": {
      "GPV4.1": {
        "1": { "1": "maybe", "2": "yes" },
        "2": { "1": "yes" }
      }
    },
    "updateFact": "04.11.2025 18:00"
  }
}
```

### Об’єкт `fact` (фактичні/аварійні на сьогодні/завтра)
Містить оперативні дані на поточний та наступний день. Поля:

- `data`: трирівнева структура:
  - рівень 1: ключ — «відро дати» у вигляді UNIX‑мітки часу в секундах (рядок), напр. `"1762380000"` — доба, до якої належать значення нижче (як у джерелі).
  - рівень 2: ключ — ідентифікатор групи (напр., `"GPV1.1"`).
  - рівень 3: ключ — годинний слот `"1".."24"` (локальний час Europe/Kyiv).
  - значення — один із кодів стану: `yes | maybe | no | first | second | mfirst | msecond` (означення — див. `preset.time_type`).
- `updateFact`: дата/час актуальності оперативних даних (рядок з джерела, без зміни формату).

Приклад (урізаний):

```json
{
  "fact": {
    "data": {
      "1762380000": {
        "GPV1.1": { "1": "yes", "2": "yes", "3": "no" },
        "GPV2.1": { "21": "second", "22": "no" }
      }
    },
    "updateFact": "06.11.2025 09:09"
  }
}
```

Примітки:
- У `fact.data` може бути кілька ключів‑дат (наприклад, на сьогодні і на завтра).
- Формати ключів і значень повністю наслідують джерело; ми їх не перетворюємо і не нормалізуємо.
- Відповідність слотів `"1".."24"` до інтервалів часу визначається за `preset.time_zone` (для плану) і є годинними інтервалами локального часу Europe/Kyiv.

---

## Налаштування джерел
Посилання на сторінки задаються однією змінною оточення/секретом `REGION_SOURCES_JSON` у форматі JSON‑мапи `{"<regionId>": "<url>"}`.

Приклад для локального `.env` (не комітиться):

```bash
REGION_SOURCES_JSON='{
  "kyiv": "https://www.dtek-kem.com.ua/ua/shutdowns",
  "kyiv-region": "https://www.dtek-krem.com.ua/ua/shutdowns",
  "odesa": "https://www.dtek-oem.com.ua/ua/shutdowns",
  "dnipro": "https://www.dtek-dnem.com.ua/ua/shutdowns"
}'
```

У GitHub → Settings → Secrets and variables → Actions додайте секрет `REGION_SOURCES_JSON` зі «сирим» JSON (без зовнішніх лапок).

---

## Локальний запуск
Передумови: `Node.js 18+`, `jq`. Для варіанта з `curl` — ще й `curl`.

Варіант A — Playwright (рекомендовано, ідентична поведінка до CI):
```bash
# одноразово встановити npm-пакет Playwright та браузерні бінарники з залежностями
npm i --no-save playwright
npx playwright install --with-deps chromium

# завантажити всі регіони (використовує REGION_SOURCES_JSON з .env або змінних середовища)
node scripts/fetch_regions_playwright.mjs

# або лише один регіон
REGION=kyiv node scripts/fetch_regions_playwright.mjs
# або через аргумент командного рядка
node scripts/fetch_regions_playwright.mjs kyiv
```
HTML зʼявиться у `outputs/<region>.html`.

Варіант B — curl (швидко перевірити локально; може впиратися у WAF):
```bash
scripts/fetch_regions.sh           # усі регіони
scripts/fetch_regions.sh kyiv      # лише один регіон
REGION=kyiv scripts/fetch_regions.sh
```

Далі — парсинг у JSON:
```bash
scripts/parse_regions.sh               # усі наявні outputs/*.html
REGION=kyiv scripts/parse_regions.sh   # лише один регіон
```
Результат — `data/<region>.json`.

У випадку помилок парсер оновлює тільки статус у JSON, не стираючи попередні дані.

---

## Як працює CI
- Пайплайн (`.github/workflows/scheduled.yml`) запускається кожні 15 хв і за ручним тригером.
- Кроки: fetch → parse → commit&push (тільки зміни у `data/*.json`).
- Потрібні права `contents: write` для `GITHUB_TOKEN`. Якщо `main` захищена — дозвольте GitHub Actions пушити або перейдіть на PR‑потік.

---

## Обмеження та антибот
- У CI тепер використовується безголовий браузер (Playwright, Chromium), який виконує JS і встановлює cookies — це допомагає коректно проходити антибот‑перевірки та отримувати «справжній» HTML.
- Локально ви можете спробувати `scripts/fetch_regions.sh` (посилені заголовки, cookie‑jar, реферер). Якщо сторінка все одно повертає WAF‑HTML — використайте Playwright‑скрипт (див. нижче).
- Якщо замість сторінки приходить WAF‑HTML, парсер виставляє код помилки (напр., 422) і зберігає наявні дані.

---

## Ліцензія та юридичні застереження
- Дані збираються з публічно доступних джерел. Дотримуйтеся умов використання сайтів.
- Репозиторій не претендує на право власності на первинні дані; див. LICENSE (MIT).

---

## Внесок
Див. файл [CONTRIBUTING.md](CONTRIBUTING.md): як повідомляти про проблеми, запускати локально, стиль коду та правила для JSON.
